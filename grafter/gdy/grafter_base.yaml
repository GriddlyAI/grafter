Version: "0.1"
Environment:
  Name: Grafter
  Description: Griddly port of the crafter environment from https://danijar.com/project/crafter/.
  Observers:
    Sprite2D:
      TileSize: [ 48, 48 ]
  Player:
    Count: 1
    AvatarObject: player
    Observer:
      HighlightPlayers: false
      TrackAvatar: true
      RotateWithAvatar: true
      RotateAvatarImage: false
#      Height: 9
#      Width: 9

  Levels:
    - |
      .

Actions:
  - Name: move
    InputMapping:
      Inputs:
        1:
          OrientationVector: [ -1, 0 ]
          VectorToDest: [ -1, 0 ]
          MetaData:
            image_idx: 1
        2:
          OrientationVector: [ 0, -1 ]
          VectorToDest: [ 0, -1 ]
          MetaData:
            image_idx: 2
        3:
          OrientationVector: [ 1, 0 ]
          VectorToDest: [ 1, 0 ]
          MetaData:
            image_idx: 3
        4:
          OrientationVector: [ 0, 1 ]
          VectorToDest: [ 0, 1 ]
          MetaData:
            image_idx: 4
    Behaviours:
      - Src:
          Object: player
          Commands:
            - mov: _dest
            - set_tile: meta.image_idx
        Dst:
          Object: [ grass, path, sand ]
      - Src:
          Object: player
          Commands:
            - set_tile: meta.image_idx
        Dst:
          Object: [ cow, water, stone, tree, player, zombie, skeleton, coal, lava, iron, diamond, table, furnace ]
          
################# SKELETON MECHANICS ######################
  - Name: skeleton_random_movement
    InputMapping:
      Inputs:
        1:
          OrientationVector: [ 0, -1 ]
          VectorToDest: [ 0, -1 ]
        2:
          OrientationVector: [ 1, 0 ]
          VectorToDest: [ 1, 0 ]
        3:
          OrientationVector: [ 0, 1 ]
          VectorToDest: [ 0, 1 ]
        4:
          OrientationVector: [ -1, 0 ]
          VectorToDest: [ -1, 0 ]
      Internal: true
    Behaviours:
    - Src:
        Object: skeleton
        Preconditions:
          - eq: [ is_chasing, 0 ]
        Commands:
          - mov: _dest
          - exec:
              Action: skeleton_random_movement
              Delay: 3
              Randomize: true
      Dst:
        Object: [ path ]

    - Src:
        Object: skeleton
        Preconditions:
          - eq: [ is_chasing, 0 ]
        Commands:
          - exec:
              Action: skeleton_random_movement
              Delay: 3
              Randomize: true
      Dst:
        Object: [ _boundary, _empty, grass, sand, cow, water, stone, tree, player, zombie, skeleton, coal, lava, iron, diamond, table, furnace ]

  - Name: skeleton_chase_player
    InputMapping:
      Inputs:
        1:
          OrientationVector: [ 0, -1 ]
          VectorToDest: [ 0, -1 ]
        2:
          OrientationVector: [ 1, 0 ]
          VectorToDest: [ 1, 0 ]
        3:
          OrientationVector: [ 0, 1 ]
          VectorToDest: [ 0, 1 ]
        4:
          OrientationVector: [ -1, 0 ]
          VectorToDest: [ -1, 0 ]
      Internal: true
    Behaviours:
      - Src:
          Object: skeleton
          Commands:
            - set: [ chase_cooldown, 0 ]
            - mov: _dest
        Dst:
          Object: [ path ]

  - Name: skeleton_chase_proximity_trigger_off
    Trigger:
      Range: 9
      Type: RANGE_BOX_BOUNDARY
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Object: skeleton
          Preconditions:
            - eq: [ is_chasing, 1 ]
          Commands:
            - set: [ is_chasing, 0 ]
            - exec:
                Action: skeleton_random_movement
                Delay: 3
                Randomize: true
        Dst:
          Object: player

  - Name: skeleton_chase_proximity_trigger_on
    Trigger:
      Range: 8
      Type: RANGE_BOX_AREA
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Preconditions:
            - eq: [ src.chase_cooldown, 0 ]
          Object: skeleton
          Commands:
            - set: [ is_chasing, 1 ]
            - set: [ chase_cooldown, 1 ]
            - exec:
                Action: skeleton_chase_player
                Delay: 3
                Search:
                  ImpassableObjects: [ water, stone, tree, coal, lava, iron, diamond, table, furnace ]
                  TargetObjectName: player
        Dst:
          Object: player

  - Name: arrow_projectile
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Object: arrow
          Commands:
            - mov: _dest
            - exec:
                Action: arrow_projectile
                Delay: 1
        Dst:
          Object: [ water, path, grass, sand ]

      - Src:
          Object: arrow
          Commands:
            - remove: true
        Dst:
          Object: [ _boundary, _empty, cow, stone, tree, zombie, skeleton, coal, lava, iron, diamond, table, furnace ]

  - Name: set_arrow_direction
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Object: arrow
          Commands:
            - set_tile: meta.image_idx
        Dst:
          Object: [ water, path, grass, sand  ]

  - Name: fire_arrow
    InputMapping:
      Inputs:
        1:
          OrientationVector: [ 0, -1 ]
          VectorToDest: [ 0, -1 ]
          MetaData:
            image_idx: 0
        2:
          OrientationVector: [ 1, 0 ]
          VectorToDest: [ 1, 0 ]
          MetaData:
            image_idx: 1
        3:
          OrientationVector: [ 0, 1 ]
          VectorToDest: [ 0, 1 ]
          MetaData:
            image_idx: 2
        4:
          OrientationVector: [ -1, 0 ]
          VectorToDest: [ -1, 0 ]
          MetaData:
            image_idx: 3
    Behaviours:
      - Src:
          Object: skeleton
        Dst:
          Object: [ water, path, grass, sand ]
          Commands:
            - spawn: arrow

  - Name: reload_arrow
    InputMapping:
      Inputs:
        1:
          VectorToDest: [0, 0]
      Internal: true
    Behaviours:
      - Src:
          Object: skeleton
          Commands:
            - set: [ reload_cooldown, 0 ]
        Dst:
          Object: skeleton

  - Name: skeleton_fire_proximity_trigger
    #Probability: 0.5
    Trigger:
      Range: 5
      Type: RANGE_BOX_AREA
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
#          Preconditions:
#            - eq: [ src.reload_cooldown, 0 ]
          Object: skeleton
          Commands:
            #- set: [ reload_cooldown, 1 ]
            - exec:
                Action: fire_arrow
                Randomize: true
#            - exec:
#                 Action: reload_arrow
#                 Delay: 1
        Dst:
          Object: player
###########################################################

##################### ZOMBIE MECHANICS ####################

  - Name: zombie_random_movement
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Object: zombie
          Preconditions:
            - eq: [ is_chasing, 0 ]
          Commands:
            - mov: _dest
            - exec:
                Action: zombie_random_movement
                Delay: 3
                Randomize: true
        Dst:
          Object: [ grass, path, sand ]
      - Src:
          Object: zombie
          Preconditions:
            - eq: [ is_chasing, 0 ]
          Commands:
            - exec:
                Action: zombie_random_movement
                Delay: 3
                Randomize: true
        Dst:
          Object: [ _boundary, _empty, cow, water, stone, tree, player, zombie, skeleton, coal, lava, iron, diamond, table, furnace ]

  - Name: zombie_chase_player
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Object: zombie
          Commands:
            - set: [ chase_cooldown, 0 ]
            - mov: _dest
        Dst:
          Object: [ grass, path, sand ]

      - Src:
          Object: zombie
          Commands:
            - set: [ chase_cooldown, 0 ]
        Dst:
          Object: [ _boundary, cow, water, stone, tree, player, zombie, skeleton, coal, lava, iron, diamond, table, furnace ]

  - Name: zombie_chase_proximity_trigger_off
    Trigger:
      Range: 9
      Type: RANGE_BOX_BOUNDARY
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Object: zombie
          Preconditions:
            - eq: [ is_chasing, 1 ]
          Commands:
            - set: [ is_chasing, 0 ]
            - exec:
                Action: zombie_random_movement
                Delay: 3
                Randomize: true
        Dst:
          Object: player
#
  - Name: zombie_chase_proximity_trigger_on
    Trigger:
      Range: 8
      Type: RANGE_BOX_AREA
    InputMapping:
      Internal: true
    Behaviours:
      - Src:
          Preconditions:
           - eq: [src.chase_cooldown, 0]
          Object: zombie
          Commands:
            - set: [ is_chasing, 1 ]
            - set: [ chase_cooldown, 1 ]
            - exec:
                Action: zombie_chase_player
                Delay: 2
                Search:
                  ImpassableObjects: [ water, stone, tree, coal, lava, iron, diamond, table, furnace ]
                  TargetObjectName: player
        Dst:
          Object: player
###########################################################

################### COW MECHANICS #########################

  # Random walk for cows
  - Name: cow_random_movement
    InputMapping:
      Inputs:
        1:
          OrientationVector: [ 1, 0 ]
          VectorToDest: [ 1, 0 ]
          MetaData:
            change_image: 1
            image_idx: 1
        2:
          OrientationVector: [ 0, -1 ]
          VectorToDest: [ 0, -1 ]
          MetaData:
            change_image: 0
        3:
          OrientationVector: [ -1, 0 ]
          VectorToDest: [ -1, 0 ]
          MetaData:
            change_image: 1
            image_idx: 0
        4:
          OrientationVector: [ 0, 1 ]
          VectorToDest: [ 0, 1 ]
          MetaData:
            change_image: 0

      Internal: true
    Behaviours:

      - Src:
          Object: cow
          Commands:
            - mov: _dest
            - exec:
                Action: cow_random_movement
                Delay: 1
                Randomize: true
            - eq:
                Arguments: [ meta.change_image, 1 ]
                Commands:
                  - set_tile: meta.image_idx
        Dst:
          Object: [ grass, path, sand ]

      - Src:
          Object: cow
          Commands:
            - exec:
                Action: cow_random_movement
                Delay: 5
                Randomize: true
        Dst:
          Object: [ _boundary, _empty, cow, water, stone, tree, player, zombie, skeleton, coal, lava, iron, diamond, table, furnace ]

###########################################################

Objects:
  - Name: player
    MapCharacter: p
    Z: 2
    Observers:
      Sprite2D:
        - Image: sprite2d/player.png
        - Image: sprite2d/player-left.png
        - Image: sprite2d/player-up.png
        - Image: sprite2d/player-right.png
        - Image: sprite2d/player-down.png
        - Image: sprite2d/player-sleep.png
  - Name: water
    MapCharacter: W
    Observers:
      Sprite2D:
        - Image: sprite2d/water.png
  - Name: grass
    MapCharacter: G
    Z: 1
    Observers:
      Sprite2D:
        - Image: sprite2d/grass.png
  - Name: stone
    MapCharacter: s
    Observers:
      Sprite2D:
        - Image: sprite2d/stone.png
  - Name: path
    Z: 1
    MapCharacter: P
    Observers:
      Sprite2D:
        - Image: sprite2d/path.png
  - Name: sand
    Z: 1
    MapCharacter: S
    Observers:
      Sprite2D:
        - Image: sprite2d/sand.png
  - Name: tree
    MapCharacter: T
    Observers:
      Sprite2D:
        - Image: sprite2d/tree.png
  - Name: lava
    MapCharacter: L
    Observers:
      Sprite2D:
        - Image: sprite2d/lava.png
  - Name: coal
    MapCharacter: c
    Observers:
      Sprite2D:
        - Image: sprite2d/coal.png
  - Name: iron
    MapCharacter: i
    Observers:
      Sprite2D:
        - Image: sprite2d/iron.png
  - Name: diamond
    MapCharacter: d
    Observers:
      Sprite2D:
        - Image: sprite2d/diamond.png
  - Name: table
    MapCharacter: t
    Observers:
      Sprite2D:
        - Image: sprite2d/table.png
  - Name: furnace
    MapCharacter: f
    Observers:
      Sprite2D:
        - Image: sprite2d/furnace.png

  - Name: arrow
    Z: 2
    MapCharacter: a
    InitialActions:
      - Action: set_arrow_direction
      - Action: arrow_projectile
        Delay: 1
    Observers:
      Sprite2D:
          - Image: sprite2d/arrow-up.png
          - Image: sprite2d/arrow-right.png
          - Image: sprite2d/arrow-down.png
          - Image: sprite2d/arrow-left.png

  - Name: zombie
    Z: 2
    InitialActions:
      - Action: zombie_random_movement
        Randomize: true
    Variables:
      - Name: health
        InitialValue: 5
      - Name: is_chasing
        InitialValue: 0
      - Name: chase_cooldown
        InitialValue: 0
    MapCharacter: '!'
    Observers:
      Sprite2D:
        - Image: sprite2d/zombie.png

  - Name: skeleton
    Z: 2
    MapCharacter: '@'
    InitialActions:
      - Action: skeleton_random_movement
        Randomize: true
    Variables:
      - Name: health
        InitialValue: 3
      - Name: is_chasing
        InitialValue: 0
      - Name: chase_cooldown
        InitialValue: 0
      - Name: reload_cooldown
        InitialValue: 0
    Observers:
      Sprite2D:
        - Image: sprite2d/skeleton.png

  - Name: cow
    InitialActions:
      - Action: cow_random_movement
        Randomize: true
    Z: 2
    MapCharacter: '#'
    Observers:
      Sprite2D:
        - Image: sprite2d/cow-left.png
        - Image: sprite2d/cow-right.png